@model School_ErP.Models.FeeDeposite
@{
    ViewData["Title"] = "New Fee Deposite";
}
<head>
    <style>
        /* Compact grid look */
        #tblMonthFee {
            border-color: #dee2e6 !important;
        }

            #tblMonthFee th, #tblMonthFee td {
                padding: 4px 6px !important;
                vertical-align: middle !important;
                border-color: #e2e3e5 !important;
            }

            /* Hover + selection look */
            #tblMonthFee tbody tr:hover {
                background-color: #f1f5ff !important;
                transition: 0.2s;
            }

            #tblMonthFee .form-check-input {
                transform: scale(1.1);
                cursor: pointer;
            }

            /* Selected Row highlight */
            #tblMonthFee tbody tr.selected-row {
                background-color: #e6f9e8 !important;
                font-weight: 600;
            }

    </style>
</head>
<div class="container mt-4">
    <div class="card shadow-lg border-0 rounded-4">
        <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
            <h5 class="mb-0" style="color:maroon">New Fee Deposite</h5>
            <a asp-action="FeeDepositeList" class="btn btn-outline-secondary btn-sm rounded-pill">Back</a>
        </div>


        <div class="card-body">
            <form asp-action="FeeDeposite" id="feeForm">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <input type="hidden" id="SelectedMonthsData" name="SelectedMonthsData" />

                <!-- Student Info -->
                <div class="row g-3 mb-3">

                    <div class="col-md-2">
                        <label asp-for="EntryDate" class="form-label fw-semibold"></label>
                        <input asp-for="EntryDate" type="date" id="EntryDate" class="form-control rounded-pill" />
                    </div>

                   
                    <div class="col-md-2">
                        <label asp-for="ReceiptNo" class="form-label fw-semibold"></label>
                        <input asp-for="ReceiptNo" class="form-control rounded-pill" placeholder="Receipt No" readonly />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Reg. No</label>
                        <input asp-for="Regno" class="form-control rounded-pill" id="txtRegNo" placeholder="Enter Reg. No" />
                    </div>


                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Student Name</label>
                        <input type="text" class="form-control rounded-pill bg-light" id="txtName" readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Father Name</label>
                        <input type="text" class="form-control rounded-pill bg-light" id="txtFather" readonly />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Class</label>
                        <input type="text" class="form-control rounded-pill bg-light" id="txtClass" readonly />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Section</label>
                        <input type="text" class="form-control rounded-pill bg-light" id="txtSection" readonly />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Contact No.</label>
                        <input type="number" class="form-control rounded-pill bg-light" id="txtContact" readonly />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Fee Category</label>
                        <input type="text" class="form-control rounded-pill bg-light" id="txtCategory" readonly />
                    </div>
                </div>

                <hr>
                <!-- Fee Details -->
                <div class="card-header bg-light fw-bold fw-bold d-flex justify-content-between align-items-lg-start">
                <h5 class="mb-0" style="color:maroon">Select Months/Installment</h5>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="fw-bold text-primary mb-2">
                            <i class="bi bi-table me-2"></i>Monthly Fee Details
                        </h6>

                        <div class="table-responsive">
                            <table class="table table-bordered table-striped text-center align-middle shadow-sm rounded-3"
                                   id="tblMonthFee" style="font-size: 0.82rem; border-radius: 8px; overflow: hidden;">
                                <thead class="table-light" style="background-color: #f7f8fa;">
                                    <tr style="font-size: 0.78rem; text-transform: uppercase;">
                                        <th style="width:5%">Sr No.</th>
                                        <th style="width:20%">Month</th>
                                        <th style="width:25%">Installment</th>
                                        <th style="width:15%">Amount (₹)</th>
                                        <th style="width:10%">Select</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <div class="row g-3">
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Total Amount</label>
                    <input asp-for="Total" class="form-control rounded-pill" readonly/>
                </div>

                    <div class="col-md-2">
                        <label asp-for="PayMode" class="form-label fw-semibold"></label>
                        <select asp-for="PayMode" id="ddlPayMode" class="form-select rounded-pill">
                            <option value="">Select</option>
                            <option>Cash</option>
                            <option>Cheque</option>
                            <option>Online</option>
                        </select>
                    </div>

                      <!-- Dynamic Section: Based on PayMode -->
                <div id="cashFields" class="row g-3 mt-2 d-none">
                    <div class="col-md-3">
                        <label asp-for="CashAmt" class="form-label fw-semibold">Cash Amount</label>
                        <input asp-for="CashAmt" class="form-control rounded-pill" placeholder="Enter Cash Amount" />
                    </div>

                     <div class="col-md-6">
                    <label class="form-label fw-semibold">Fee Recv. - Bank Name</label>
                    <select asp-for="Bank" class="form-select rounded-pill">
                        <option value="IOB">IOB</option>
                        <option value="SBI">SBI</option>
                    </select>
                </div>

                </div>

                <div id="chequeFields" class="row g-3 mt-2 d-none">
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Cheque No.</label>
                        <input type="text" class="form-control rounded-pill" id="ChequeNo" name="ChequeNo" placeholder="Enter Cheque No." />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Cheque Date</label>
                        <input type="date" class="form-control rounded-pill" id="ChequeDate" name="ChequeDate" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Cheque Amount</label>
                        <input type="number" class="form-control rounded-pill" id="ChequeAmount" name="ChequeAmount" placeholder="Enter Amount" />
                    </div>

                        <div class="col-md-6">
                        <label class="form-label fw-semibold">Cheque Bank</label>
                        <input type="text" class="form-control rounded-pill" id="ChequeBank" name="Bank" placeholder="Enter Bank Name" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Fee Recv. - Bank Name</label>
                            <select asp-for="Bank" class="form-select rounded-pill">
                                <option value="IOB">IOB</option>
                                <option value="SBI">SBI</option>
                            </select>
                        </div>

                </div>

                <div id="onlineFields" class="row g-3 mt-2 d-none">
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Transaction No.</label>
                            <input type="text" class="form-control rounded-pill" id="TransNo" name="TransNo" placeholder="Enter Transaction No." />
                        </div>

                     <div class="col-md-6">
                    <label class="form-label fw-semibold">Fee Recv. - Bank Name</label>
                    <select asp-for="Bank" class="form-select rounded-pill">
                        <option value="IOB">IOB</option>
                        <option value="SBI">SBI</option>
                    </select>
                </div>

                </div>
                </div>


                <div class="row g-3 mt-2">
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Late Fee</label>
                    <input type="text" class="form-control rounded-pill" id="Late" name="Late" value="0.00"/>
                </div>

                <div class="col-md-2">
                    <label class="form-label fw-semibold">Concession</label>
                    <input type="text" class="form-control rounded-pill" id="Concession" name="Concession" value="0.00" />
                </div>

                 <div class="col-md-12">
                        <label asp-for="Remark" class="form-label fw-semibold"></label>
                        <textarea asp-for="Remark" rows="2" class="form-control rounded-3" placeholder="Remarks..."></textarea>
                    </div>
                </div>

                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-success rounded-pill px-4" onclick="prepareSelectedMonths()">💾 Save</button>
                    <a asp-action="FeeDepositeList" class="btn btn-outline-secondary rounded-pill px-4">Cancel</a>

                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
              document.getElementById("txtRegNo").addEventListener("change", function () {
            var regNo = this.value.trim();
            if (regNo === "") return;

            debugger;

            fetch(`/Fee/GetStudentByRegNo?regNo=${regNo}`)
                .then(res => res.json())
                .then(data => {
                    debugger;
                    if (data.success && data.data) {
                        document.getElementById("txtName").value = data.data.studentName || "";
                        document.getElementById("txtFather").value = data.data.fatherName || "";
                        document.getElementById("txtClass").value = data.data.currentClass || "";
                        document.getElementById("txtSection").value = data.data.section || "";
                        document.getElementById("txtContact").value = data.data.smsno || "";
                        document.getElementById("txtCategory").value = data.data.feeCategory || "";
                        
                        loadMonthFeeGrid(data.data.currentClass);

                    } else {
                        alert(data.message || "Student not found!");
                        document.querySelectorAll("#txtName, #txtFather, #txtClass, #txtSection, #txtContact, #txtCategory").forEach(i => i.value = "");
                    }
                })
                .catch(err => console.error("Error fetching student data:", err));
        });

        // 🔹 Show/Hide PayMode specific fields
        document.getElementById("ddlPayMode").addEventListener("change", function () {
            const mode = this.value;
            document.getElementById("cashFields").classList.add("d-none");
            document.getElementById("chequeFields").classList.add("d-none");
            document.getElementById("onlineFields").classList.add("d-none");

            if (mode === "Cash") {
                document.getElementById("cashFields").classList.remove("d-none");
            } else if (mode === "Cheque") {
                document.getElementById("chequeFields").classList.remove("d-none");
            } else if (mode === "Online") {
                document.getElementById("onlineFields").classList.remove("d-none");
            }
        });


        document.querySelector("form").addEventListener("submit", function (e) {
            const selectedMonths = [];
            document.querySelectorAll(".select-month:checked").forEach(chk => {
                const row = chk.closest("tr");
                const month = row.cells[1].innerText.trim();
                const installment = row.cells[2].innerText.trim();
                const amount = parseFloat(chk.getAttribute("data-amount")) || 0;

                selectedMonths.push({
                    Month: month,
                    Installment: installment,
                    Amount: amount
                });
            });

            if (selectedMonths.length === 0) {
                alert("Please select at least one month or installment!");
                e.preventDefault(); // stop form from submitting
                return;
            }

            // Put JSON string into hidden field
            document.getElementById("SelectedMonthsData").value = JSON.stringify(selectedMonths);
        });

         

                // 🔹 Set today's date by default in EntryDate field
        document.addEventListener("DOMContentLoaded", function () {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById("EntryDate").value = today;
        });

                function loadMonthFeeGrid(className) {
            fetch(`/Fee/GetMonthFeeByClass?className=${className}`)
                .then(res => res.json())
                .then(data => {
                    const tbody = document.querySelector("#tblMonthFee tbody");
                    tbody.innerHTML = ""; // Clear old data

                    if (data.success && data.data.length > 0) {
                        data.data.forEach(row => {
                            const tr = document.createElement("tr");
                                   tr.innerHTML = `
                        <td>${row.srNo}</td>
                        <td>${row.monthName}</td>
                        <td>${row.installment}</td>
                        <td>${row.amount}</td>
                        <td>
                        <input type="checkbox" name="SelectedMonths" value="${row.monthName}"
                        class="form-check-input select-month" data-amount="${row.amount}" />
                        </td>
                    `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        tbody.innerHTML = `<tr><td colspan="4" class="text-danger">No fee data found for this class.</td></tr>`;
                    }
                })
                .catch(err => console.error("Error loading month fee:", err));
        }


                  // 🔹 Checkbox change event
        document.addEventListener("change", function (e) {
            if (e.target.classList.contains("select-month")) {
                let total = 0;
                let selectedMonths = []; // <-- ye define karna zaruri hai

                // Calculate total & collect selected months
                document.querySelectorAll(".select-month").forEach(cb => {
                    const row = cb.closest("tr");
                    const month = row.children[1].innerText;
                    const installment = row.children[2].innerText;
                    const amount = parseFloat(cb.dataset.amount) || 0;

                    if (cb.checked) {
                        total += amount;
                        row.classList.add("selected-row");

                        selectedMonths.push({
                            Month: month,
                            Installment: installment,
                            Amount: amount
                        });
                    } else {
                        row.classList.remove("selected-row");
                    }
                });

                // Set total value in Total textbox
                const totalInput = document.querySelector("[name='Total'], #Total");
                if (totalInput) totalInput.value = total.toFixed(2);

                // Update PayMode-related fields automatically
                updatePayModeAmounts(total);

                // Convert selected months to JSON & store in hidden field
                const hiddenField = document.getElementById("SelectedMonthsData");
                if (hiddenField) hiddenField.value = JSON.stringify(selectedMonths);
            }
        });

        // 🔹 Pay Mode change event
        document.getElementById("ddlPayMode").addEventListener("change", function () {
            const total = parseFloat(document.querySelector("[name='Total'], #Total")?.value || 0);
            updatePayModeAmounts(total);
        });

        // 🔹 Function to update Cash/Cheque/Online fields
        function updatePayModeAmounts(total) {
            const mode = document.getElementById("ddlPayMode").value;
            const cashAmt = document.querySelector("[name='CashAmt'], #CashAmt");
            const chequeAmt = document.querySelector("[name='ChequeAmount'], #ChequeAmount");
            const transNo = document.getElementById("TransNo");

            // Reset values
            if (cashAmt) cashAmt.value = "";
            if (chequeAmt) chequeAmt.value = "";
            if (transNo) transNo.value = "";

            // Apply values based on mode
            if (mode === "Cash") {
                if (cashAmt) cashAmt.value = total.toFixed(2);
                if (chequeAmt) chequeAmt.value = 0;
            }
            else if (mode === "Cheque") {
                if (chequeAmt) chequeAmt.value = total.toFixed(2);
                if (cashAmt) cashAmt.value = 0;
            }
            else if (mode === "Online") {
                if (cashAmt) cashAmt.value = total.toFixed(2); // using CashAmt for online
                if (chequeAmt) chequeAmt.value = 0;
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const selectedMonths = @Html.Raw(ViewBag.SelectedMonths ?? "[]");

            // if data present, tick corresponding checkboxes
            selectedMonths.forEach(item => {
                document.querySelectorAll(".select-month").forEach(chk => {
                    const row = chk.closest("tr");
                    const monthName = row.cells[1].innerText.trim();
                    if (monthName === item.Month) {
                        chk.checked = true;
                    }
                });
            });
        });

    </script>
}
